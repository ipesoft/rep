<fieldset class="module aligned {{ fieldset.classes }}">
    <a name="fset{{ forloop.counter }}">{% if fieldset.name %}<h2>{{ fieldset.name }}</h2>{% endif %}</a>
    {% if fieldset.description %}
        <div class="description">{{ fieldset.description|safe }}</div>
    {% endif %}
    {% for line in fieldset %}
        <div class="form-row{% if line.fields|length_is:'1' and line.errors %} errors{% endif %}{% for field in line %} {{ field.field.name }}{% endfor %}">
            {% if line.fields|length_is:'1' %}{{ line.errors }}{% endif %}
            {% for field in line %}
                <div{% if not line.fields|length_is:'1' %} class="field-box{% if not field.is_readonly and field.errors %} errors{% endif %}"{% endif %}>
                    {% if not line.fields|length_is:'1' and not field.is_readonly %}{{ field.errors }}{% endif %}
                    {% if field.is_checkbox %}
                        {{ field.field }}{{ field.label_tag }}
                    {% else %}
                        {{ field.label_tag }}
                        {% if field.is_readonly %}
                            <p>{{ field.contents }}</p>
                        {% else %}
                            {{ field.field }}
                        {% endif %}
                    {% endif %}
                    {% if field.field.help_text %}
                        <p class="help">{{ field.field.help_text|safe }}</p>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    {% endfor %}
{% comment %}
This template is called from inside a loop to render all fieldsets.
The following code is a hack to embed inlines between certain fieldsets.

{% endcomment %}
{% with fset_cnt=forloop.counter %}
  {% comment %}INSERT AFTER THE FIRST FIELDSET{% endcomment %}
  {% if fset_cnt == 1 %}
    {% comment %}FIRST INLINE (SYNONYMS){% endcomment %}
    {% with inline_admin_formset=inline_admin_formsets.0 %}
    {% include inline_admin_formset.opts.template %}
    {% endwith %}
    {% comment %}THEN SECOND INLINE (COMMON NAMES){% endcomment %}
    {% with inline_admin_formset=inline_admin_formsets.1 %}
    {% include inline_admin_formset.opts.template %}
    {% endwith %}
  {% comment %}INSERT AFTER THE FOURTH FIELDSET{% endcomment %}
  {% elif fset_cnt == 4 %}
    {% comment %}THIRD INLINE (USES){% endcomment %}
    {% with inline_admin_formset=inline_admin_formsets.2 %}
    {% include inline_admin_formset.opts.template %}
    {% endwith %}
    {% comment %}FOURTH INLINE (USE REFS){% endcomment %}
    {% with inline_admin_formset=inline_admin_formsets.3 %}
    {% include inline_admin_formset.opts.template %}
    {% endwith %}
    {% comment %}FIFTH INLINE (HABITATS){% endcomment %}
    {% with inline_admin_formset=inline_admin_formsets.4 %}
    {% include inline_admin_formset.opts.template %}
    {% endwith %}
    {% comment %}SIXTH INLINE (HABITAT REFS){% endcomment %}
    {% with inline_admin_formset=inline_admin_formsets.5 %}
    {% include inline_admin_formset.opts.template %}
    {% endwith %}
  {% elif fset_cnt > 4 %}
    {% comment %}PICK THE CORRESPONDING REFERENCE INLINE AFTER THE NEXT FIELDSETS{% endcomment %}
    {% comment %}i.e. for each fieldset n greater than 4, include inline n (count starts at 1!){% endcomment %}
    {% for inline_admin_formset in inline_admin_formsets %}{% if forloop.counter == fset_cnt|add:2 %}{% include inline_admin_formset.opts.template %}{% endif %}{% endfor %}
  {% elif fset_cnt == 37 %}
    {% with inline_admin_formset=inline_admin_formsets.38 %}
    {% include inline_admin_formset.opts.template %}
    {% endwith %}
  {% endif %}
{% endwith %}
</fieldset>
